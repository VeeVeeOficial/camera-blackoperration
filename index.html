<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Camera Flip Backend - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #0f172a;
    }
    header {
      background: #020617;
      color: white;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 {
      font-size: 18px;
      margin: 0;
    }
    .nav {
      display: flex;
      gap: 8px;
    }
    .nav button {
      background: transparent;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.8);
      color: #e5e7eb;
      padding: 4px 10px;
      font-size: 13px;
      cursor: pointer;
    }
    .nav button.active {
      background: #22c55e;
      border-color: #22c55e;
      color: #022c22;
    }

    .page {
      max-width: 1200px;
      margin: 16px auto;
      padding: 0 12px 32px;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 10px 40px rgba(15,23,42,0.20);
    }
    h2 {
      margin-top: 0;
      font-size: 18px;
    }
    label {
      display: block;
      font-size: 13px;
      margin-top: 8px;
    }
    input, select, textarea {
      width: 100%;
      padding: 6px 8px;
      margin-top: 3px;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
      font-size: 13px;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .col-3 { flex: 0 0 calc(25% - 8px); }
    .col-4 { flex: 0 0 calc(33.333% - 8px); }
    .col-6 { flex: 0 0 calc(50% - 8px); }
    .col-12 { flex: 0 0 100%; }

    button {
      padding: 7px 14px;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-primary {
      background: #22c55e;
      color: #022c22;
    }
    .btn-outline {
      background: white;
      color: #0f172a;
      border: 1px solid #cbd5f5;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }
    th {
      background: #eff6ff;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #e5e7eb;
    }
    .tag.ready { background:#dcfce7; color:#166534; }
    .tag.repair { background:#fef9c3; color:#92400e; }
    .tag.sold { background:#e0f2fe; color:#075985; }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(200px,1fr));
      gap: 12px;
    }
    .stat-card {
      background: #020617;
      color:#e5e7eb;
      border-radius: 12px;
      padding: 12px 14px;
      position: relative;
      overflow:hidden;
    }
    .stat-label { font-size:12px; color:#9ca3af; }
    .stat-value { font-size:22px; margin-top:4px; }
    .stat-sub { font-size:11px; color:#9ca3af; margin-top:2px; }

    /* Toast Notification */
    .toast {
      position: fixed;
      top: 80px;
      right: 20px;
      background: white;
      padding: 12px 16px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      display: none;
      z-index: 1000;
      max-width: 300px;
      border-left: 4px solid #22c55e;
    }
    .toast.show { display: block; animation: slideIn 0.3s ease; }
    .toast.error { border-left-color: #ef4444; }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Filter Tabs */
    .filter-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .filter-tabs button {
      padding: 6px 12px;
      background: #f3f4f6;
      color: #374151;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
    }
    .filter-tabs button.active {
      background: #3b82f6;
      color: white;
    }

    /* Autocomplete */
    .autocomplete {
      position: relative;
    }
    .autocomplete-items {
      position: absolute;
      border: 1px solid #d4d4d4;
      background: white;
      z-index: 99;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 200px;
      overflow-y: auto;
      border-radius: 6px;
      margin-top: 2px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .autocomplete-items div {
      padding: 8px;
      cursor: pointer;
      border-bottom: 1px solid #f3f4f6;
      font-size: 13px;
    }
    .autocomplete-items div:hover {
      background-color: #f3f4f6;
    }
    .autocomplete-active {
      background-color: #3b82f6 !important;
      color: white;
    }

    /* Loading Spinner */
    .spinner {
      border: 2px solid #f3f3f3;
      border-top: 2px solid #22c55e;
      border-radius: 50%;
      width: 14px;
      height: 14px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .col-3, .col-4, .col-6 { flex: 0 0 100%; }
      header h1 { font-size: 16px; }
      .toast { right: 10px; left: 10px; max-width: none; }
    }
  </style>
</head>
<body>
<header>
  <h1>üì∑ Camera Flip Backend</h1>
  <div class="nav">
    <button data-page="dashboard" class="active">Dashboard</button>
    <button data-page="inventory">‡∏™‡∏ï‡πá‡∏≠‡∏Å</button>
    <button data-page="sales">‡∏Ç‡∏≤‡∏¢</button>
    <button data-page="purchases">‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤</button>
    <button data-page="repairs">‡∏ã‡πà‡∏≠‡∏° & ‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</button>
    <button data-page="cash">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î & ‡∏´‡∏ô‡∏µ‡πâ</button>
  </div>
</header>

<!-- Toast Notification -->
<div id="toast" class="toast"></div>

<div id="page-dashboard" class="page">
  <div class="card" style="background:transparent; box-shadow:none; padding:0;">
    <div class="stat-grid">
      <div class="stat-card">
        <div class="stat-label">‡∏Ç‡∏≠‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å (‡∏ä‡∏¥‡πâ‡∏ô)</div>
        <div class="stat-value" id="stat-stock-count">-</div>
        <div class="stat-sub">‡∏ä‡∏¥‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ç‡∏≤‡∏¢</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å</div>
        <div class="stat-value" id="stat-stock-value">-</div>
        <div class="stat-sub">‡∏ö‡∏≤‡∏ó</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">‡∏Å‡∏≥‡πÑ‡∏£‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
        <div class="stat-value" id="stat-profit-month">-</div>
        <div class="stat-sub">‡∏ö‡∏≤‡∏ó (‡∏à‡∏≤‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß)</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">‡∏Å‡∏≥‡πÑ‡∏£‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
        <div class="stat-value" id="stat-profit-total">-</div>
        <div class="stat-sub">‡∏ö‡∏≤‡∏ó</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏£‡πâ‡∏≤‡∏ô</div>
        <div class="stat-value" id="stat-cash">-</div>
        <div class="stat-sub">‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (‡∏ï‡∏≤‡∏° CashMovements)</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>‡∏Å‡∏≥‡πÑ‡∏£‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>
    <canvas id="chart-profit-month"></canvas>
  </div>
</div>

<!-- INVENTORY -->
<div id="page-inventory" class="page" style="display:none;">
  <div class="card">
    <h2>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å</h2>
    <div class="row">
      <div class="col-3">
        <label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
          <select id="inv-category">
            <option value="Camera Body">Camera Body</option>
            <option value="Lens">Lens</option>
            <option value="Flash">Flash</option>
            <option value="Accessory">Accessory</option>
          </select>
        </label>
      </div>
      <div class="col-3">
        <label>‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠ (Brand)
          <input id="inv-brand" placeholder="Canon / Sony / Sigma" />
        </label>
      </div>
      <div class="col-3">
        <label>‡∏£‡∏∏‡πà‡∏ô (Model)
          <input id="inv-model" placeholder="1DX II / 5D4 / ‡∏Ø‡∏•‡∏Ø" />
        </label>
      </div>
      <div class="col-3">
        <label>Serial Number
          <input id="inv-sn" />
        </label>
      </div>

      <div class="col-3">
        <label>‡∏™‡∏†‡∏≤‡∏û (A / B+ / ‡∏ï‡∏≥‡∏´‡∏ô‡∏¥)
          <input id="inv-condition" />
        </label>
      </div>
      <div class="col-3">
        <label>Status
          <select id="inv-status">
            <option value="‡∏£‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ">‡∏£‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ</option>
            <option value="‡∏£‡∏≠‡∏ã‡πà‡∏≠‡∏°">‡∏£‡∏≠‡∏ã‡πà‡∏≠‡∏°</option>
            <option value="‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢</option>
          </select>
        </label>
      </div>
      <div class="col-3">
        <label>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ã‡∏∑‡πâ‡∏≠ (base_cost)
          <input id="inv-base-cost" type="number" step="0.01" />
        </label>
      </div>
      <div class="col-3">
        <label>‡∏Ñ‡πà‡∏≤‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (repair_cost)
          <input id="inv-repair-cost" type="number" step="0.01" value="0" />
        </label>
      </div>

      <div class="col-3">
        <label>‡∏Ñ‡πà‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á ‡∏Ø‡∏•‡∏Ø)
          <input id="inv-other-cost" type="number" step="0.01" value="0" />
        </label>
      </div>
      <div class="col-3">
        <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ç‡∏≤‡∏¢ (list_price)
          <input id="inv-list-price" type="number" step="0.01" />
        </label>
      </div>
      <div class="col-3">
        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á (YYYY-MM-DD)
          <input id="inv-received-at" />
        </label>
      </div>
    </div>
    <br>
    <button class="btn-primary" id="btn-inv-add">
      <span id="btn-inv-add-text">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
    </button>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å</h2>
      <button class="btn-outline" id="btn-inv-reload">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
    </div>
    
    <!-- Filter Tabs -->
    <div class="filter-tabs">
      <button class="active" data-filter="available">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢</button>
      <button data-filter="sold">‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</button>
      <button data-filter="repair">‡∏£‡∏≠‡∏ã‡πà‡∏≠‡∏°</button>
      <button data-filter="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>

    <div id="inv-summary" style="font-size:13px;margin-bottom:8px;"></div>
    <div style="max-height:420px;overflow:auto;">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
            <th>SN</th>
            <th>‡∏™‡∏†‡∏≤‡∏û</th>
            <th>Status</th>
            <th>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</th>
            <th>‡∏ï‡∏±‡πâ‡∏á‡∏Ç‡∏≤‡∏¢</th>
            <th>‡∏Ç‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á</th>
            <th>‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á</th>
            <th>‡∏Ç‡∏≤‡∏¢</th>
            <th>‡∏Å‡∏≥‡πÑ‡∏£</th>
            <th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
          </tr>
        </thead>
        <tbody id="inv-tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- SALES -->
<div id="page-sales" class="page" style="display:none;">
  <div class="card">
    <h2>‡∏≠‡∏≠‡∏Å‡∏ö‡∏¥‡∏•‡∏Ç‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß</h2>
    <p style="font-size:13px;color:#6b7280;">üí° ‡∏û‡∏¥‡∏°‡∏û‡πå ID, ‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∏‡πà‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
    <div class="row">
      <div class="col-3">
        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢
          <input id="sale-date" placeholder="2025-12-29" />
        </label>
      </div>
      <div class="col-3">
        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
          <input id="sale-customer" />
        </label>
      </div>
      <div class="col-3">
        <label>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á
          <input id="sale-channel" placeholder="FB / Shopee / ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô" />
        </label>
      </div>
      <div class="col-3">
        <label>‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡πà‡∏≤‡∏¢
          <input id="sale-payment" placeholder="‡πÇ‡∏≠‡∏ô / ‡∏™‡∏î / COD" />
        </label>
      </div>
    </div>
    <div class="row">
      <div class="col-4">
        <label>‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏™‡πà‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
          <input id="sale-tracking" />
        </label>
      </div>
      <div class="col-4">
        <label>‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á (‡∏ö‡∏ß‡∏Å/‡∏•‡∏ö‡∏£‡∏ß‡∏°‡πÉ‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ)
          <input id="sale-ship" type="number" step="0.01" value="0" />
        </label>
      </div>
      <div class="col-4">
        <label>‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°
          <input id="sale-fee" type="number" step="0.01" value="0" />
        </label>
      </div>
    </div>

    <hr style="margin:12px 0;">

    <div class="row">
      <div class="col-4">
        <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤)
          <div class="autocomplete">
            <input id="sale-item-search" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå ID / ‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠ / ‡∏£‡∏∏‡πà‡∏ô..." autocomplete="off" />
            <div id="autocomplete-list" class="autocomplete-items"></div>
          </div>
        </label>
      </div>
      <div class="col-4">
        <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á (‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô)
          <input id="sale-price" type="number" step="0.01" />
        </label>
      </div>
      <div class="col-4">
        <label>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î
          <input id="sale-discount" type="number" step="0.01" value="0" />
        </label>
      </div>
    </div>

    <div id="selected-item-preview" style="margin-top:8px;padding:8px;background:#f3f4f6;border-radius:6px;font-size:13px;display:none;">
      <strong>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</strong> <span id="preview-text"></span>
    </div>

    <br>
    <button class="btn-primary" id="btn-sale-submit">
      <span id="btn-sale-submit-text">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</span>
    </button>
  </div>

  <div class="card">
    <h2>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 50 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</h2>
    <div style="max-height:420px;overflow:auto;">
      <table>
        <thead>
          <tr>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
            <th>‡∏ö‡∏¥‡∏•</th>
            <th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
            <th>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</th>
            <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
            <th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Ç‡∏≤‡∏¢</th>
          </tr>
        </thead>
        <tbody id="sales-tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- PURCHASES -->
<div id="page-purchases" class="page" style="display:none;">
  <div class="card">
    <h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤</h2>
    <div class="row">
      <div class="col-3">
        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠
          <input id="pur-date" />
        </label>
      </div>
      <div class="col-3">
        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢
          <input id="pur-seller" />
        </label>
      </div>
      <div class="col-3">
        <label>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á
          <input id="pur-channel" placeholder="FB ‡∏Å‡∏•‡∏∏‡πà‡∏° / Marketplace ‡∏Ø‡∏•‡∏Ø" />
        </label>
      </div>
      <div class="col-3">
        <label>‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡πà‡∏≤‡∏¢
          <input id="pur-payment" placeholder="‡πÇ‡∏≠‡∏ô / ‡∏™‡∏î" />
        </label>
      </div>

      <div class="col-3">
        <label>‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
          <input id="pur-account" placeholder="MAIN / KBank ‡∏Ø‡∏•‡∏Ø" />
        </label>
      </div>
      <div class="col-3">
        <label>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢
          <input id="pur-amount" type="number" step="0.01" />
        </label>
      </div>
      <div class="col-3">
        <label>‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏Ç‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤
          <input id="pur-track" />
        </label>
      </div>
      <div class="col-3">
        <label>‡πÇ‡∏ô‡πâ‡∏ï
          <input id="pur-note" />
        </label>
      </div>
    </div>
    <br>
    <button class="btn-primary" id="btn-pur-submit">
      <span id="btn-pur-submit-text">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠</span>
    </button>
  </div>

  <div class="card">
    <h2>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠ (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 50 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</h2>
    <div style="max-height:420px;overflow:auto;">
      <table>
        <thead>
          <tr>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
            <th>ID</th>
            <th>‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢</th>
            <th>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</th>
            <th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>
            <th>‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏</th>
          </tr>
        </thead>
        <tbody id="pur-tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- REPAIRS -->
<div id="page-repairs" class="page" style="display:none;">
  <div class="card">
    <h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</h2>
    <div class="row">
      <div class="col-3">
        <label>Item ID ‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏°
          <input id="rep-item-id" />
        </label>
      </div>
      <div class="col-3">
        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏°
          <input id="rep-send" />
        </label>
      </div>
      <div class="col-3">
        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à
          <input id="rep-done" />
        </label>
      </div>
      <div class="col-3">
        <label>‡∏£‡πâ‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏° / ‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏≠‡∏á
          <input id="rep-shop" />
        </label>
      </div>

      <div class="col-6">
        <label>‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
          <input id="rep-problem" />
        </label>
      </div>
      <div class="col-6">
        <label>‡∏ß‡∏¥‡∏ò‡∏µ‡∏ã‡πà‡∏≠‡∏° / ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏≥
          <input id="rep-actions" />
        </label>
      </div>

      <div class="col-3">
        <label>‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏ä‡πà‡∏≤‡∏á
          <input id="rep-labor" type="number" step="0.01" value="0" />
        </label>
      </div>
      <div class="col-3">
        <label>Part ID (‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏´‡∏•‡∏±‡∏Å 1 ‡∏ä‡∏¥‡πâ‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡∏°‡πà‡∏≤‡∏ô ‡∏Ø‡∏•‡∏Ø)
          <input id="rep-part-id" />
        </label>
      </div>
      <div class="col-3">
        <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ
          <input id="rep-part-qty" type="number" step="1" value="0" />
        </label>
      </div>
    </div>
    <br>
    <button class="btn-primary" id="btn-rep-submit">
      <span id="btn-rep-submit-text">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</span>
    </button>
  </div>

  <div class="card">
    <h2>‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å</h2>
    <div class="row">
      <div class="col-4">
        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà
          <input id="part-name" />
        </label>
      </div>
      <div class="col-4">
        <label>‡∏£‡∏∏‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ (‡πÇ‡∏ô‡πâ‡∏ï)
          <input id="part-models" />
        </label>
      </div>
      <div class="col-2">
        <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
          <input id="part-qty" type="number" />
        </label>
      </div>
      <div class="col-2">
        <label>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏ä‡∏¥‡πâ‡∏ô
          <input id="part-cost" type="number" step="0.01" />
        </label>
      </div>
    </div>
    <br>
    <button class="btn-primary" id="btn-part-submit">
      <span id="btn-part-submit-text">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡πÉ‡∏´‡∏°‡πà</span>
    </button>

    <hr style="margin:12px 0;">

    <div style="max-height:320px;overflow:auto;">
      <table>
        <thead>
          <tr>
            <th>Part ID</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</th>
            <th>‡∏£‡∏∏‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ</th>
            <th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
            <th>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏ä‡∏¥‡πâ‡∏ô</th>
          </tr>
        </thead>
        <tbody id="parts-tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- CASH & LOANS -->
<div id="page-cash" class="page" style="display:none;">
  <div class="card">
    <h2>‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î & ‡∏´‡∏ô‡∏µ‡πâ (‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏à‡∏≤‡∏Å Dashboard/CashMovements)</h2>
    <p style="font-size:13px;">
      ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ñ‡∏∏‡∏ì‡∏î‡∏π‡∏à‡∏≤‡∏Å Dashboard Summary ‡πÅ‡∏•‡∏∞‡∏ä‡∏µ‡∏ï CashMovements / Loans ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢<br>
      ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ / ‡∏Å‡∏π‡πâ‡πÄ‡∏á‡∏¥‡∏ô: ‡πÉ‡∏ä‡πâ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
    </p>
  </div>

  <div class="card">
    <h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡πÉ‡∏´‡∏°‡πà</h2>
    <div class="row">
      <div class="col-3">
        <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ
          <input id="loan-lender" placeholder="‡πÅ‡∏°‡πà / ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô / ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£" />
        </label>
      </div>
      <div class="col-3">
        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏π‡πâ
          <input id="loan-date" />
        </label>
      </div>
      <div class="col-3">
        <label>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ (Principal)
          <input id="loan-amount" type="number" step="0.01" />
        </label>
      </div>
      <div class="col-3">
        <label>‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ (% ‡∏ï‡πà‡∏≠‡∏õ‡∏µ ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡∏Ñ‡∏∏‡∏ì‡∏ô‡∏¥‡∏¢‡∏≤‡∏°)
          <input id="loan-rate" type="number" step="0.01" />
        </label>
      </div>
      <div class="col-3">
        <label>‡∏¢‡∏≠‡∏î‡∏ú‡πà‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡∏á‡∏ß‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
          <input id="loan-install" type="number" step="0.01" />
        </label>
      </div>
      <div class="col-9">
        <label>‡πÇ‡∏ô‡πâ‡∏ï
          <input id="loan-note" />
        </label>
      </div>
    </div>
    <br>
    <button class="btn-primary" id="btn-loan-submit">
      <span id="btn-loan-submit-text">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ</span>
    </button>
  </div>

  <div class="card">
    <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ</h2>
    <div style="max-height:320px;overflow:auto;">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ</th>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°</th>
            <th>‡∏¢‡∏≠‡∏î‡∏Å‡∏π‡πâ</th>
            <th>‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
            <th>‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</th>
          </tr>
        </thead>
        <tbody id="loans-tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // *** ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô URL ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏≠‡∏õ Apps Script ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á ***
  const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbwqsk-kJBiV85mh1Y7gnQ2npnJvvMuwWMWt83JZ2k73JS2IivSPP9e6oTaVz-cyeyMqcQ/exec';
  
  let allItems = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö autocomplete
  let currentFilter = 'available'; // Filter ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô

  // Toast Notification
  function showToast(message, isError = false) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = 'toast show' + (isError ? ' error' : '');
    setTimeout(() => toast.className = 'toast', 3000);
  }

  async function apiGet(params) {
    const url = new URL(API_BASE_URL);
    Object.entries(params).forEach(([k,v]) => url.searchParams.set(k,v));
    const res = await fetch(url.toString());
    return res.json();
  }
  
  async function apiPost(action, data) {
    const url = new URL(API_BASE_URL);
    url.searchParams.set('action', action);
    
    const formData = new FormData();
    formData.append('payload', JSON.stringify(data));
    
    const res = await fetch(url.toString(), {
      method: 'POST',
      body: formData
    });
    return res.json();
  }
  
  function money(n) {
    const num = Number(n || 0);
    if (isNaN(num)) return '-';
    return num.toLocaleString('th-TH', {maximumFractionDigits:0});
  }
  
  function tagClass(status) {
    if (!status) return 'tag';
    if (status.includes('‡∏Ç‡∏≤‡∏¢')) return 'tag sold';
    if (status.includes('‡∏ã‡πà‡∏≠‡∏°')) return 'tag repair';
    if (status.includes('‡∏û‡∏£‡πâ‡∏≠‡∏°')) return 'tag ready';
    return 'tag';
  }

  // Set button loading state
  function setButtonLoading(buttonId, isLoading, originalText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å') {
    const btn = document.getElementById(buttonId);
    const textSpan = document.getElementById(buttonId + '-text');
    if (isLoading) {
      btn.disabled = true;
      textSpan.innerHTML = '<span class="spinner"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
    } else {
      btn.disabled = false;
      textSpan.textContent = originalText;
    }
  }

  // NAV
  document.querySelectorAll('.nav button').forEach(btn => {
    btn.addEventListener('click', () => {
      const page = btn.dataset.page;
      document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
      document.getElementById('page-' + page).style.display = 'block';
    });
  });

  /******** DASHBOARD ********/
  let profitChart;
  async function loadDashboard() {
    try {
      const res = await apiGet({action:'dashboardSummary'});
      if (!res.ok) throw new Error(res.error || 'error');
      const d = res.data;
      document.getElementById('stat-stock-count').textContent = d.stockCount;
      document.getElementById('stat-stock-value').textContent = money(d.stockValue);
      document.getElementById('stat-profit-month').textContent = money(d.profitThisMonth);
      document.getElementById('stat-profit-total').textContent = money(d.profitTotal);
      document.getElementById('stat-cash').textContent = money(d.cashBalance);

      const labels = d.profitByMonth.map(x => x.month);
      const values = d.profitByMonth.map(x => x.profit);

      const ctx = document.getElementById('chart-profit-month').getContext('2d');
      if (profitChart) profitChart.destroy();
      profitChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: '‡∏Å‡∏≥‡πÑ‡∏£‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ö‡∏≤‡∏ó)',
            data: values,
            borderColor: '#22c55e',
            backgroundColor: 'rgba(34, 197, 94, 0.1)',
            tension: 0.3
          }]
        },
        options: {
          responsive:true,
          scales:{ y:{ beginAtZero:true } }
        }
      });
    } catch (err) {
      console.error(err);
      showToast('‡πÇ‡∏´‡∏•‡∏î Dashboard ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', true);
    }
  }

  /******** INVENTORY ********/
  async function loadInventory() {
    const tbody = document.getElementById('inv-tbody');
    tbody.innerHTML = '<tr><td colspan="12">Loading...</td></tr>';
    try {
      const res = await apiGet({action:'listItems'});
      if (!res.ok) throw new Error(res.error || 'error');
      allItems = res.data || [];
      renderInventory();
    } catch (err) {
      tbody.innerHTML = '<tr><td colspan="12">Error: '+err.message+'</td></tr>';
      showToast('‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', true);
    }
  }

  function renderInventory() {
    const tbody = document.getElementById('inv-tbody');
    
    // Filter items based on current filter
    let filteredItems = allItems;
    if (currentFilter === 'available') {
      filteredItems = allItems.filter(it => !it.sold_price && it.status === '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢');
    } else if (currentFilter === 'sold') {
      filteredItems = allItems.filter(it => it.sold_price);
    } else if (currentFilter === 'repair') {
      filteredItems = allItems.filter(it => it.status && it.status.includes('‡∏ã‡πà‡∏≠‡∏°'));
    }

    // Sort by received_at (newest first)
    filteredItems.sort((a, b) => {
      const dateA = a.received_at || '';
      const dateB = b.received_at || '';
      return dateB.localeCompare(dateA);
    });

    let stockCount = 0, stockValue = 0, profitTotal = 0;
    tbody.innerHTML = '';

    filteredItems.forEach(it => {
      const cost = Number(it.total_cost || 0);
      const sold = Number(it.sold_price || 0);
      let pf = 0;
      if (!sold) {
        stockCount++;
        stockValue += cost;
      } else {
        pf = sold - cost;
        profitTotal += pf;
      }
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${it.id}</td>
        <td><strong>${it.brand || ''} ${it.model || ''}</strong><br><span style="font-size:11px;">${it.category || ''}</span></td>
        <td>${it.sn || ''}</td>
        <td>${it.condition || ''}</td>
        <td><span class="${tagClass(it.status)}">${it.status || ''}</span></td>
        <td>${money(cost)}</td>
        <td>${money(it.list_price)}</td>
        <td>${money(it.sold_price)}</td>
        <td>${it.received_at || ''}</td>
        <td>${it.sold_at || ''}</td>
        <td style="color:${pf>0?'green':(pf<0?'red':'#555')}">${sold?money(pf):'-'}</td>
        <td><button class="btn-outline" style="font-size:11px;" onclick="editItemPrompt('${it.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById('inv-summary').innerHTML =
      `‡πÅ‡∏™‡∏î‡∏á <strong>${filteredItems.length}</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ | ‡∏Ç‡∏≠‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å <strong>${stockCount}</strong> ‡∏ä‡∏¥‡πâ‡∏ô | ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô <strong>${money(stockValue)}</strong> ‡∏ö‡∏≤‡∏ó | ‡∏Å‡∏≥‡πÑ‡∏£‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß <strong>${money(profitTotal)}</strong> ‡∏ö‡∏≤‡∏ó`;
  }

  // Filter tabs
  document.querySelectorAll('.filter-tabs button').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.filter-tabs button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentFilter = btn.dataset.filter;
      renderInventory();
    });
  });

  async function addInventoryItem() {
    const payload = {
      category: document.getElementById('inv-category').value,
      brand: document.getElementById('inv-brand').value,
      model: document.getElementById('inv-model').value,
      sn: document.getElementById('inv-sn').value,
      condition: document.getElementById('inv-condition').value,
      status: document.getElementById('inv-status').value,
      base_cost: document.getElementById('inv-base-cost').value,
      repair_cost: document.getElementById('inv-repair-cost').value,
      other_cost: document.getElementById('inv-other-cost').value,
      list_price: document.getElementById('inv-list-price').value,
      received_at: document.getElementById('inv-received-at').value
    };
    
    setButtonLoading('btn-inv-add', true);
    try {
      const res = await apiPost('createItem', payload);
      if (!res.ok) throw new Error(res.error || 'error');
      showToast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      await loadInventory();
      await loadDashboard();
      
      // Clear form
      document.getElementById('inv-brand').value = '';
      document.getElementById('inv-model').value = '';
      document.getElementById('inv-sn').value = '';
      document.getElementById('inv-condition').value = '';
      document.getElementById('inv-base-cost').value = '';
      document.getElementById('inv-repair-cost').value = '0';
      document.getElementById('inv-other-cost').value = '0';
      document.getElementById('inv-list-price').value = '';
      document.getElementById('inv-received-at').value = '';
    } catch (err) {
      showToast('‚ùå ' + err.message, true);
    } finally {
      setButtonLoading('btn-inv-add', false, '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
    }
  }

  async function editItemPrompt(id) {
    try {
      const res = await apiGet({action:'getItem', id});
      if (!res.ok || !res.data) { 
        showToast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', true); 
        return; 
      }
      const it = res.data;
      const newStatus = prompt('Status ‡πÉ‡∏´‡∏°‡πà (Cancel = ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)', it.status || '');
      const soldPrice = prompt('‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á (‡∏ß‡πà‡∏≤‡∏á = ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ç‡∏≤‡∏¢)', it.sold_price || '');
      let soldAt = it.sold_at || '';
      if (soldPrice && soldPrice !== '0') {
        soldAt = prompt('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢ (YYYY-MM-DD)', soldAt || '');
      }
      const payload = { id: it.id };
      if (newStatus !== null) payload.status = newStatus;
      if (soldPrice !== null) payload.sold_price = soldPrice;
      if (soldAt !== null) payload.sold_at = soldAt;
      const res2 = await apiPost('updateItem', payload);
      if (!res2.ok) throw new Error(res2.error || 'error');
      showToast('‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      await loadInventory();
      await loadDashboard();
    } catch (err) {
      showToast('‚ùå ' + err.message, true);
    }
  }

  /******** AUTOCOMPLETE FOR SALES ********/
  let selectedItemId = null;
  const searchInput = document.getElementById('sale-item-search');
  const autocompleteList = document.getElementById('autocomplete-list');

  searchInput.addEventListener('input', function() {
    const val = this.value.toLowerCase();
    autocompleteList.innerHTML = '';
    
    if (!val) {
      selectedItemId = null;
      hideItemPreview();
      return;
    }

    const matches = allItems.filter(it => {
      if (it.sold_price) return false; // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß
      const searchStr = `${it.id} ${it.brand} ${it.model} ${it.category}`.toLowerCase();
      return searchStr.includes(val);
    }).slice(0, 10); // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà 10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å

    matches.forEach(it => {
      const div = document.createElement('div');
      div.innerHTML = `<strong>${it.id}</strong> - ${it.brand} ${it.model} <span style="color:#6b7280;">(${money(it.list_price)} ‡∏ö‡∏≤‡∏ó)</span>`;
      div.addEventListener('click', function() {
        selectedItemId = it.id;
        searchInput.value = `${it.id} - ${it.brand} ${it.model}`;
        document.getElementById('sale-price').value = it.list_price || '';
        autocompleteList.innerHTML = '';
        showItemPreview(it);
      });
      autocompleteList.appendChild(div);
    });
  });

  function showItemPreview(item) {
    const preview = document.getElementById('selected-item-preview');
    const text = document.getElementById('preview-text');
    text.textContent = `${item.brand} ${item.model} (${item.id}) - ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ç‡∏≤‡∏¢ ${money(item.list_price)} ‡∏ö‡∏≤‡∏ó`;
    preview.style.display = 'block';
  }

  function hideItemPreview() {
    document.getElementById('selected-item-preview').style.display = 'none';
  }

  // Close autocomplete when clicking outside
  document.addEventListener('click', function(e) {
    if (e.target !== searchInput) {
      autocompleteList.innerHTML = '';
    }
  });

  /******** SALES ********/
  async function loadSales() {
    const tbody = document.getElementById('sales-tbody');
    tbody.innerHTML = '<tr><td colspan="6">Loading...</td></tr>';
    try {
      const res = await apiGet({action:'listSales'});
      if (!res.ok) throw new Error(res.error || 'error');
      const sales = (res.data || []).slice().reverse().slice(0,50);
      tbody.innerHTML = '';
      sales.forEach(s => {
        let total = 0;
        const items = s.items || [];
        items.forEach(i => total += Number(i.selling_price || 0) - Number(i.discount || 0));
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${s.sale_date || ''}</td>
          <td>${s.id}</td>
          <td>${s.customer_name || ''}</td>
          <td>${s.channel || ''}</td>
          <td>${items.length}</td>
          <td>${money(total)}</td>
        `;
        tbody.appendChild(tr);
      });
    } catch (err) {
      tbody.innerHTML = '<tr><td colspan="6">Error: '+err.message+'</td></tr>';
      showToast('‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', true);
    }
  }

  async function submitSale() {
    if (!selectedItemId) {
      showToast('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô', true);
      return;
    }

    const sellingPrice = document.getElementById('sale-price').value;
    if (!sellingPrice || Number(sellingPrice) <= 0) {
      showToast('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢', true);
      return;
    }

    const payload = {
      sale_date: document.getElementById('sale-date').value,
      customer_name: document.getElementById('sale-customer').value,
      customer_contact: '',
      channel: document.getElementById('sale-channel').value,
      payment_method: document.getElementById('sale-payment').value,
      shipping_tracking: document.getElementById('sale-tracking').value,
      shipping_cost: document.getElementById('sale-ship').value,
      platform_fee: document.getElementById('sale-fee').value,
      items: [{
        item_id: selectedItemId,
        selling_price: sellingPrice,
        discount: document.getElementById('sale-discount').value
      }]
    };

    setButtonLoading('btn-sale-submit', true);
    try {
      const res = await apiPost('createSale', payload);
      if (!res.ok) throw new Error(res.error || 'error');
      showToast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      await loadSales();
      await loadInventory();
      await loadDashboard();
      
      // Clear form
      searchInput.value = '';
      selectedItemId = null;
      hideItemPreview();
      document.getElementById('sale-price').value = '';
      document.getElementById('sale-discount').value = '0';
      document.getElementById('sale-customer').value = '';
      document.getElementById('sale-tracking').value = '';
    } catch (err) {
      showToast('‚ùå ' + err.message, true);
    } finally {
      setButtonLoading('btn-sale-submit', false, '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢');
    }
  }

  /******** PURCHASES ********/
  async function loadPurchases() {
    const tbody = document.getElementById('pur-tbody');
    tbody.innerHTML = '<tr><td colspan="6">Loading...</td></tr>';
    try {
      const res = await apiGet({action:'listPurchases'});
      if (!res.ok) throw new Error(res.error || 'error');
      const data = (res.data || []).slice().reverse().slice(0,50);
      tbody.innerHTML = '';
      data.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.purchase_date || ''}</td>
          <td>${p.id}</td>
          <td>${p.seller_name || ''}</td>
          <td>${p.source_channel || ''}</td>
          <td>${money(p.total_amount)}</td>
          <td>${p.tracking_in || ''}</td>
        `;
        tbody.appendChild(tr);
      });
    } catch (err) {
      tbody.innerHTML = '<tr><td colspan="6">Error: '+err.message+'</td></tr>';
      showToast('‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', true);
    }
  }

  async function submitPurchase() {
    const payload = {
      purchase_date: document.getElementById('pur-date').value,
      seller_name: document.getElementById('pur-seller').value,
      seller_contact: '',
      source_channel: document.getElementById('pur-channel').value,
      payment_method: document.getElementById('pur-payment').value,
      paid_from_account: document.getElementById('pur-account').value || 'MAIN',
      total_amount: document.getElementById('pur-amount').value,
      tracking_in: document.getElementById('pur-track').value,
      note: document.getElementById('pur-note').value
    };
    
    setButtonLoading('btn-pur-submit', true);
    try {
      const res = await apiPost('createPurchase', payload);
      if (!res.ok) throw new Error(res.error || 'error');
      showToast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      await loadPurchases();
      await loadDashboard();
      
      // Clear form
      document.getElementById('pur-seller').value = '';
      document.getElementById('pur-amount').value = '';
      document.getElementById('pur-track').value = '';
      document.getElementById('pur-note').value = '';
    } catch (err) {
      showToast('‚ùå ' + err.message, true);
    } finally {
      setButtonLoading('btn-pur-submit', false, '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠');
    }
  }

  /******** PARTS & REPAIRS ********/
  async function loadParts() {
    const tbody = document.getElementById('parts-tbody');
    tbody.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';
    try {
      const res = await apiGet({action:'listParts'});
      if (!res.ok) throw new Error(res.error || 'error');
      const parts = res.data || [];
      tbody.innerHTML = '';
      parts.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.id}</td>
          <td>${p.part_name || ''}</td>
          <td>${p.compatible_models || ''}</td>
          <td>${p.stock_qty || 0}</td>
          <td>${money(p.unit_cost)}</td>
        `;
        tbody.appendChild(tr);
      });
    } catch (err) {
      tbody.innerHTML = '<tr><td colspan="5">Error: '+err.message+'</td></tr>';
      showToast('‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', true);
    }
  }

  async function submitPart() {
    const payload = {
      part_name: document.getElementById('part-name').value,
      compatible_models: document.getElementById('part-models').value,
      stock_qty: document.getElementById('part-qty').value,
      unit_cost: document.getElementById('part-cost').value
    };
    
    setButtonLoading('btn-part-submit', true);
    try {
      const res = await apiPost('createPart', payload);
      if (!res.ok) throw new Error(res.error || 'error');
      showToast('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      await loadParts();
      
      // Clear form
      document.getElementById('part-name').value = '';
      document.getElementById('part-models').value = '';
      document.getElementById('part-qty').value = '';
      document.getElementById('part-cost').value = '';
    } catch (err) {
      showToast('‚ùå ' + err.message, true);
    } finally {
      setButtonLoading('btn-part-submit', false, '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡πÉ‡∏´‡∏°‡πà');
    }
  }

  async function submitRepair() {
    const payload = {
      item_id: document.getElementById('rep-item-id').value,
      problem_description: document.getElementById('rep-problem').value,
      repair_actions: document.getElementById('rep-actions').value,
      labor_cost: document.getElementById('rep-labor').value,
      repair_shop: document.getElementById('rep-shop').value,
      send_date: document.getElementById('rep-send').value,
      done_date: document.getElementById('rep-done').value,
      parts: []
    };
    const partId = document.getElementById('rep-part-id').value;
    const qty = Number(document.getElementById('rep-part-qty').value || 0);
    if (partId && qty > 0) {
      payload.parts.push({ part_id: partId, qty });
    }
    
    setButtonLoading('btn-rep-submit', true);
    try {
      const res = await apiPost('createRepair', payload);
      if (!res.ok) throw new Error(res.error || 'error');
      showToast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      await loadInventory();
      await loadParts();
      await loadDashboard();
      
      // Clear form
      document.getElementById('rep-item-id').value = '';
      document.getElementById('rep-problem').value = '';
      document.getElementById('rep-actions').value = '';
      document.getElementById('rep-labor').value = '0';
      document.getElementById('rep-part-id').value = '';
      document.getElementById('rep-part-qty').value = '0';
    } catch (err) {
      showToast('‚ùå ' + err.message, true);
    } finally {
      setButtonLoading('btn-rep-submit', false, '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°');
    }
  }

  /******** LOANS ********/
  async function loadLoans() {
    const tbody = document.getElementById('loans-tbody');
    tbody.innerHTML = '<tr><td colspan="6">Loading...</td></tr>';
    try {
      const res = await apiGet({action:'listLoans'});
      if (!res.ok) throw new Error(res.error || 'error');
      const loans = res.data || [];
      tbody.innerHTML = '';
      loans.forEach(l => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${l.id}</td>
          <td>${l.lender_name || ''}</td>
          <td>${l.start_date || ''}</td>
          <td>${money(l.principal_amount)}</td>
          <td>${money(l.remaining_balance)}</td>
          <td>${l.interest_rate || 0}%</td>
        `;
        tbody.appendChild(tr);
      });
    } catch (err) {
      tbody.innerHTML = '<tr><td colspan="6">Error: '+err.message+'</td></tr>';
      showToast('‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', true);
    }
  }

  async function submitLoan() {
    const payload = {
      lender_name: document.getElementById('loan-lender').value,
      start_date: document.getElementById('loan-date').value,
      principal_amount: document.getElementById('loan-amount').value,
      interest_rate: document.getElementById('loan-rate').value,
      installment_amount: document.getElementById('loan-install').value,
      note: document.getElementById('loan-note').value
    };
    
    setButtonLoading('btn-loan-submit', true);
    try {
      const res = await apiPost('createLoan', payload);
      if (!res.ok) throw new Error(res.error || 'error');
      showToast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      await loadLoans();
      await loadDashboard();
      
      // Clear form
      document.getElementById('loan-lender').value = '';
      document.getElementById('loan-amount').value = '';
      document.getElementById('loan-rate').value = '';
      document.getElementById('loan-install').value = '';
      document.getElementById('loan-note').value = '';
    } catch (err) {
      showToast('‚ùå ' + err.message, true);
    } finally {
      setButtonLoading('btn-loan-submit', false, '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ');
    }
  }

  // EVENT BIND
  document.getElementById('btn-inv-add').addEventListener('click', addInventoryItem);
  document.getElementById('btn-inv-reload').addEventListener('click', loadInventory);
  document.getElementById('btn-sale-submit').addEventListener('click', submitSale);
  document.getElementById('btn-pur-submit').addEventListener('click', submitPurchase);
  document.getElementById('btn-part-submit').addEventListener('click', submitPart);
  document.getElementById('btn-rep-submit').addEventListener('click', submitRepair);
  document.getElementById('btn-loan-submit').addEventListener('click', submitLoan);

  // Auto-fill today's date
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('sale-date').value = today;
  document.getElementById('pur-date').value = today;
  document.getElementById('inv-received-at').value = today;

  // INITIAL LOAD
  (async function init() {
    await loadDashboard();
    await loadInventory();
    await loadSales();
    await loadPurchases();
    await loadParts();
    await loadLoans();
  })();
</script>
</body>
</html>
